/**
 * https://github.com/binoculars/aws-cloudformation-cognito-identity-pool
 */

'use strict';

const https = require('https');
const url = require('url');
const AWS = require('aws-sdk');
const cognitoidentity = new AWS.CognitoIdentity();
const SUCCESS = 'SUCCESS';
const FAILED = 'FAILED';
const UNKNOWN = {
	Error: 'Unknown operation'
};
const requestTypes = [
	'Create',
	'Update',
	'Delete'
];

/**
 * The Lambda function handler
 * See also: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/crpg-ref.html
 * 
 * @param {!Object} event
 * @param {!string} event.RequestType
 * @param {!string} event.ServiceToken
 * @param {!string} event.ResponseURL
 * @param {!string} event.StackId
 * @param {!string} event.RequestId
 * @param {!string} event.LogicalResourceId
 * @param {!string} event.PhysicalResourceId
 * @param {!Object} event.ResourceProperties
 * @param {!Object} event.ResourceProperties.Options
 * @param {!Object} context
 * @param {!Requester~requestCallback} callback
 */
exports.handler = (event, context, callback) => {
	// console.log(event, context);
	
	function respond(responseStatus, responseData, physicalResourceId) {
		const responseBody = JSON.stringify({
			Status: responseStatus,
			Reason: `See the details in CloudWatch Log Stream: ${context.logStreamName}`,
			PhysicalResourceId: physicalResourceId || context.logStreamName,
			StackId: event.StackId,
			RequestId: event.RequestId,
			LogicalResourceId: event.LogicalResourceId,
			Data: responseData
		});
		
		// console.log('Response body:\n', responseBody);
		
		const parsedUrl = url.parse(event.ResponseURL);
		const options = {
			hostname: parsedUrl.hostname,
			port: 443,
			path: parsedUrl.path,
			method: 'PUT',
			headers: {
				'content-type': '',
				'content-length': responseBody.length
			}
		};
		
		return new Promise((resolve, reject) => {
				const request = https
					.request(options, resolve);
			
				request.on('error', error => reject(`send(..) failed executing https.request(..): ${error}`));
				request.write(responseBody);
				request.end();
			})
			.then(() => callback(responseStatus === FAILED ? responseStatus : null, responseData))
			.catch(callback);
	}
	
	if (!~requestTypes.indexOf(event.RequestType))
		return respond(FAILED, UNKNOWN);
	
	const requestType = event.RequestType;
	const params = requestType === 'Delete' ? {} : event.ResourceProperties.Options;
	
	switch (event.LogicalResourceId) {
		case 'CognitoIdentityPool':
			if (requestType !== 'Create')
				params.IdentityPoolId = event.PhysicalResourceId;
			
			// CloudFormation passes the value as a string, so it must be converted to a valid javascript object
			if (requestType !== 'Delete') {
				const parseParams = [
					'AllowUnauthenticatedIdentities',
					'CognitoIdentityProviders',
					'OpenIdConnectProviderARNs',
					'SamlProviderARNs',
					'SupportedLoginProviders'
				];
				
				try {
					for (let param of parseParams) {
						if (params[param])
							params[param] = JSON.parse(params[param]);
					}
				} catch (ex) {
					return respond(FAILED, {message: ex});
				}
			}
			
			return cognitoidentity
				[`${requestType.toLowerCase()}IdentityPool`](params)
				.promise()
				.then(data => respond(SUCCESS, data, data.IdentityPoolId))
				.catch(error => respond(FAILED, {message: error}));
		case 'CognitoIdentityPoolRoles':
			switch (requestType) {
				case 'Create':
				case 'Update':
					return cognitoidentity
						.setIdentityPoolRoles(params)
						.promise()
						.then(data => respond(SUCCESS, data))
						.catch(error => respond(FAILED, {message: error}));
				case 'Delete':
					return respond(SUCCESS);
			}
			break;
		default:
			return respond(FAILED, UNKNOWN);
	}
};